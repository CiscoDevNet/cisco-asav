#  Copyright (c) 2025 Cisco Systems Inc or its affiliates.
#
#  All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

AWSTemplateFormatVersion: 2010-09-09
Transform: 'AWS::Serverless-2016-10-31'
Description: >-
  Deploys Multi-AZ Autoscaling-enabled Cluster solution for Cisco ASAv instances 
Parameters:
  ClusterGrpNamePrefix:
    Description: >-
      This will be Cluster Group Name prefix with suffix as Cluster Number
    Type: String
    MaxLength: 18
    Default: MultiASAv-Cluster
  ClusterNumber:
    Description: >-
      This will be suffixed to Cluster Group Name(ASAv-Cluster), if this value is 1 then, group name will be
      ASAv-Cluster-1, It should be at least 1 numerical digit but not more than 3 digits.
    Type: String
    Default: 1
    AllowedPattern: '^\d{1,3}$'
    ConstraintDescription: must be a numerical string matching '^\d{1,3}$'
  DeploymentType:
    Description: >-
      Specify whether "single-arm" or "dual-arm" deployment required.
      NOTE : dual-arm supported for versions 9.24.1 and above.
      - Dual-arm East-West traffic requires application vms in 10.0.0.0/8, 172.16.0.0/12, or 192.168.0.0/16.
    Type: String
    Default: "single-arm"
    AllowedValues:
      - "single-arm"
      - "dual-arm"
  ClusterSize:
    Description: >-
      Total Number of ASAv Nodes in the Cluster (Min 1 and Max 16).
    Type: Number
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
      - 10
      - 11
      - 12
      - 13
      - 14
      - 15
      - 16
    Default: 4
  NotifyEmailID:
    Description: >-
      Email address to which Cluster Events Email needs to be sent.
      You will receive a subscription confirmation Email.
      Click on "Confirm subscription".
    Type: String
  VpcId:
    Description: >-
      Select VPC for Cluster group
    Type: AWS::EC2::VPC::Id
  VpcIdLBE:
    Description: >-
      Select VPC to deploy Gateway Load Balancer Endpoint.
      - *SKIP this field, if you are NOT deploying Gateway Load Balancer Endpoint.
    Type: String
    Default: "SKIP, if you are NOT deploying Gateway Load Balancer Endpoint."
  LambdaSubnets:
    Description: >-
      Please provide at least 2 subnet for Lambda functions. Note that these 2 subnet should have NAT GW,
      because Lambda functions should communicate with AWS Services which are public DNS.
      Order in which, you select subnet does't matter. Reference https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html
    Type: List<AWS::EC2::Subnet::Id>
  LambdaSG:
    Description: >-
      Provide Security Group for Lambda functions, Keep outbound connections to ANYWHERE.
    Type: List<AWS::EC2::SecurityGroup::Id>
  NoOfAZs:
    Description: >-
      Total Number of Availability Zones into which ASAv will be deployed (Min 1 and Max 3 depends on Region).
      PLEASE SELECT NoOfAZs = 2 OR 3 ONLY FOR RELEASES 9.22 AND ABOVE. FOR LOWER RELEASES, SELECT 1.
      Management, Inside, CCL subnets will span across AZs based on below parameter.
    Type: Number
    AllowedValues:
      - 1
      - 2
      - 3
    Default: 3
  AZ:
    Type: List<AWS::EC2::AvailabilityZone::Name>
    Description: Select Availability Zones to launch ASAvs(Count should match with Number of Availability Zones)
  DeployGWLBE:
    Description: >-
      Please select "Yes", if you like to deploy Gateway Load Balancer Endpoint.
    Type: String
    AllowedValues:
     - "Yes"
     - "No"
    Default: "No"
  TargetFailover:
    Description: >-
      Enable Target Failover Support ("rebalance" or "no_rebalance").
      'no_rebalance' - Directs existing flows to failed targets and new flows to healthy targets, ensuring backward compatibility.
      'rebalance' - GWLB redistributes existing flows while ensuring new flows go to healthy targets.
    Type: String
    AllowedValues:
     - "rebalance"
     - "no_rebalance"
    Default: "rebalance"
  S3BktName:
    Description: The S3 Bucket name for lambda function
    Type: String
    AllowedPattern: '(?=^.{3,63}$)(?!^(\d+\.)+\d+$)(^(([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])\.)*([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])$)'
    ConstraintDescription: must be a valid S3 bucket name
    Default: asav-multiinfra-s3bucketcluster-laawfubf2rct
  TgHealthPort:
    Description: >-
      Provide Health Probe Port for Gateway Load Balancer.
      - Note By default this port shouldn't be used for traffic.
    Type: String
    AllowedPattern: '^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$'
    ConstraintDescription: must be a valid TCP port
    Default: 7070
  AssignPublicIP:
    Description: >-
      Please select true if ASAVs need to have public IP address. In case ASAv needs to have public IP then management
      subnet should have AWS IGW as route to internet.
    Type: String
    AllowedValues:
      - true
      - false
    Default: true
  GWLBESubnetId:
    Description: >-
      Enter only one subnet ID.
      - *SKIP this field, if you are NOT deploying Gateway Load Balancer Endpoint.
      Wrong Subnet selection will cause problems.
      Make sure Subnet belongs to correct VPC, and belongs to the AZs specified above.
    Type: String
    Default: "SKIP, if you are NOT deploying Gateway Load Balancer Endpoint."
  MgmtInterfaceSG:
    Description: >-
      Please select security group ID for ASAv instances
    Type: List<AWS::EC2::SecurityGroup::Id>
  MgmtSubnetIds:
    Description: >-
      Select subnets from multiple AZs as required
    Type: List<AWS::EC2::Subnet::Id>
  InsideInterfaceSG:
    Description: >-
      Please select security group ID for NGFWv instances inside interface
      Make sure of adding Security Group for all AZs provided.
    Type: List<AWS::EC2::SecurityGroup::Id>
  InsideSubnetIds:
    Description: >-
      Select subnets from multiple AZs as required
    Type: List<AWS::EC2::Subnet::Id>
  OutsideInterfaceSG:
    Description: >-
      (dual-arm mode only)
      Please provide security group ID for NGFWv instances outside interface.
      Format: sg-12345678
      Do NOT remove default value, if you are using single-arm deployment.
    Type: String
    Default: sg-12345678
  OutsideSubnetIds:
    Description: >-
      (dual-arm mode only)
      Provide only one subnet per AZ. If multiple subnets from same AZ are chosen,
      wrong Subnet selection will cause problems while deploying the NGFWv instances.
      Make sure of adding Subnet from AZ provided.
      Format: subnet-12345678, subnet-12345679, subnet-12345670
      Do NOT remove default values, if you are using single-arm deployment.
    Type: CommaDelimitedList
    Default: subnet-12345678, subnet-12345679, subnet-12345670
  CCLInterfaceSG:
    Description: >-
      Please select security group ID for ASAv instances CCL interface
    Type: AWS::EC2::SecurityGroup::Id
  CCLSubnetIds:
    Description: >-
      Select subnets from multiple AZs as required
    Type: List<AWS::EC2::Subnet::Id>
  CCLSubnetRanges:
    Description: >-
      Enter IP range of CCL subnets for different AZs.
      Exclude first 4 reserved IPs.
      This is the IP pool for Cluster Control Link (CCL),
      IP will be allocated to ASAvs' CCL interfaces from CCL IP Pool.
    Type: CommaDelimitedList
    ConstraintDescription: must be a valid IP address
    Default: 10.3.90.4 10.3.90.30,10.3.91.4 10.3.91.30,10.3.92.4 10.3.92.30
  InstanceType:
    Description: >-
      Cisco ASAv EC2 instance type.
      Make sure that AWS Region supports selected instance type.
    Type: String
    AllowedValues:
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m5zn.xlarge
      - m5zn.2xlarge
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5d.xlarge
      - c5d.2xlarge
      - c5d.4xlarge
      - c5a.xlarge
      - c5a.2xlarge
      - c5a.4xlarge
      - c5ad.xlarge
      - c5ad.2xlarge
      - c5ad.4xlarge
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
    Default: c5.xlarge
  LicenseType:
    Description: >-
      Choose Cisco ASAv EC2 instance license type, make sure AMI ID which will be entered below is of same licensing type.
    Type: String
    AllowedValues:
      - BYOL
      - PAYG
    Default: BYOL
  SmartLicToken:
    Description: >-
      [Optional] Provide Cisco Smart Software License token for Regiration of ASAv devices.
    Type: String
  AmiID:
    Description: >-
      Please choose correct AMI ID as per the region, desired version and license type(BYOL/PAYG).
      ASAv version 9.19 onwards support clustering, versions 9.22 onwards supports the multi-AZ enhancements
    Type: AWS::EC2::Image::Id
    Default: ami-024f546cb9cbae1bb
  ConfigFileURL:
    Description: >-
      [Optional] Example: https://asav-example.s3.amazonaws.com/asav-configuration.txt
      - Please note that url should be accessible by the device.
      - Device should have public ip assigned.
    Type: String
  KmsArn:
    Description: >-
      [Conditional] ARN of an existing KMS (AWS KMS key to encrypt at rest), If specified, ASAv 'admin' Password below should be encrypted
      Password. The Password encryption should be done only using the specified ARN.
      Generating Encrypted Password Ex: " aws kms encrypt --key-id <KMS ARN> --plaintext <password> ", Please use such generated password in below fields.
    Type: String
  asavPassword:
    Description: >-
      All ASAv instances come up with default password, which is in Userdata field of Launch Template(Cluster Group).
      Password will be changed to given(below) password once ASAv is accessible.
      Since this can be a plain text password or KMS encrypted password, minimum length should be 8 characters.
    NoEcho: true
    MinLength: 8
    Type: String
    ConstraintDescription: password must be of minimum 8 characters
    Default: c0mpleX@1209
  CpuThresholds:
    Description: >-
      [Optional] Specifying non-zero lower and upper threshold will create respective Scale policies.
      If 0,0 is selected, no cpu scaling alarm or policies will be created.
      Evaluation points & Data points are kept default/recommended values
    Type: CommaDelimitedList
    Default: 10,70
    AllowedValues:
      - 0,0
      - 0,90
      - 0,80
      - 0,70
      - 0,60
      - 0,50
      - 0,40
      - 0,30
      - 0,20
      - 0,10
      - 5,90
      - 5,70
      - 5,50
      - 5,30
      - 5,15
      - 10,90
      - 10,80
      - 10,70
      - 10,60
      - 10,50
      - 10,40
      - 10,30
      - 10,20
      - 10,0
      - 20,90
      - 20,80
      - 20,70
      - 20,60
      - 20,50
      - 20,30
      - 20,0
      - 30,90
      - 30,80
      - 30,70
      - 30,60
      - 30,50
      - 30,40
      - 30,0
      - 40,90
      - 40,80
      - 40,70
      - 40,60
      - 40,50
      - 40,0
      - 50,90
      - 50,80
      - 50,70
      - 50,60
      - 50,0
      - 60,90
      - 60,80
      - 60,70
      - 60,0
      - 70,90
      - 70,80
      - 70,0
      - 80,95
      - 80,90
      - 80,0
      - 90,95
      - 90,0
  InstanceMetadataServiceVersion:
    Description: Select IMDS version to be used by the instances
    Type: String
    Default: "V1 and V2 (token optional)"
    AllowedValues:
      - "V1 and V2 (token optional)"
      - "V2 only (token required) [IMDSv2 ONLY APPLICABLE FOR VERSION 9.22 AND ABOVE]"

# Conditions section - defines conditional logic for resource creation
Conditions:
  support1zone: !Equals
    - !Ref NoOfAZs
    - 1
  support2zone: !Equals
    - !Ref NoOfAZs
    - 2
  support3zone: !Equals
    - !Ref NoOfAZs
    - 3
  UserNotifyEmail: !Not
    - !Equals
      - ''
      - !Ref NotifyEmailID
  Config_url: !Not
    - !Equals
      - ''
      - !Ref ConfigFileURL
  Lic_token: !Not
    - !Equals
      - ''
      - !Ref SmartLicToken
  ShouldEncrypt: !Not
    - !Equals
      - ''
      - !Ref KmsArn
  addGWLBE: !Not
    - !Equals
      - "No"
      - !Ref DeployGWLBE
  DoCpuUpPolcy: !Not
    - !Equals
      - 0
      - !Select ['1', !Ref CpuThresholds ]
  DoCpuLowPolcy: !Not
    - !Equals
      - 0
      - !Select ['0', !Ref CpuThresholds ]
  EnableIMDSv2:
    Fn::Equals:
      - !Ref InstanceMetadataServiceVersion
      - "V2 only (token required) [IMDSv2 ONLY APPLICABLE FOR VERSION 9.22 AND ABOVE]"
  dualarm: !Equals [ !Ref DeploymentType, "dual-arm" ]
  dualarmSupport2Zone: !And [ !Condition "dualarm", !Condition "support2zone" ]
  dualarmSupport3Zone: !And [ !Condition "dualarm", !Condition "support3zone" ]

# Template metadata - defines parameter groups and labels for AWS Console
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Cluster Configuration
        Parameters:
          - ClusterGrpNamePrefix
          - ClusterNumber
          - ClusterSize
          - DeploymentType
      - Label:
          default: Infrastructure Details
        Parameters:
          - NoOfAZs
          - AZ
          - NotifyEmailID
          - S3BktName
          - VpcId
          - MgmtSubnetIds
          - InsideSubnetIds
          - OutsideSubnetIds
          - CCLSubnetIds
          - LambdaSubnets
          - CCLSubnetRanges
          - MgmtInterfaceSG
          - InsideInterfaceSG
          - OutsideInterfaceSG
          - CCLInterfaceSG
          - LambdaSG
      - Label:
          default: GWLB Configuration
        Parameters:
          - DeployGWLBE
          - VpcIdLBE
          - GWLBESubnetId
          - TargetFailover
          - TgHealthPort
      - Label:
          default: Cisco ASAv Instance Configuration
        Parameters:
          - InstanceType
          - LicenseType
          - SmartLicToken
          - AssignPublicIP
          - AmiID
          - ConfigFileURL
          - KmsArn
          - asavPassword
          - InstanceMetadataServiceVersion
      - Label:
          default: Scaling Thresholds Configuration
        Parameters:
          - CpuThresholds
    ParameterLabels:
      ClusterGrpNamePrefix:
        default: Cluster Group Name Prefix
      NotifyEmailID:
        default: Cluster Email Notification
      ClusterNumber:
        default: Cluster Number
      DeploymentType:
        default: Deployment Type
      ClusterSize:
        default: Cluster Size
      VpcId:
        default: VPC ID
      VpcIdLBE:
        default: VPC ID for Gateway Load Balancer Endpoint
      DeployGWLBE:
        default: Deploy Gateway Load Balancer Endpoint
      LambdaSubnets:
        default: Subnets for Lambda Functions
      LambdaSG:
        default: Security Groups for Lambda Functions
      NoOfAZs:
        default: Number of Availibility Zones
      AZ:
        default: Enter Valid Availability Zone
      S3BktName:
        default: S3 Bucket Name
      TargetFailover:
        default: Target Failover
      TgHealthPort:
        default: Enter Health Check Port for Gateway Load Balancer
      InstanceType:
        default: ASAv Instance type
      LicenseType:
        default: ASAv Instance License type
      SmartLicToken:
        default: ASAv Smart Software Licnese Token
      AmiID:
        default: ASAv AMI-ID
      ConfigFileURL:
        default: Configuration file URL
      AssignPublicIP:
        default: Assign Public IP for ASAv from AWS IP Pool
      GWLBESubnetId:
        default: Subnet ID for Gateway Load Balancer Endpoint
      MgmtInterfaceSG:
        default: Security Groups for ASAv Instance
      MgmtSubnetIds:
        default: Subnet for ASAv Management Interface
      InsideInterfaceSG:
        default: Security Group for ASAv Instance inside
      InsideSubnetIds:
        default: Subnet for ASAv Inside Interface
      OutsideInterfaceSG:
        default: Security Group for NGFWv Instance outside
      OutsideSubnetIds:
        default: Subnet for NGFWv Outside Interface of different AZs
      CCLInterfaceSG:
        default: Security Group for ASAv CCL
      CCLSubnetIds:
        default: Subnet for ASAv CCL Interface
      CCLSubnetRanges:
        default: IP range of CCL Subnets for different AZs (CCL IP Pool)
      KmsArn:
        default: KMS Master Key ARN
      asavPassword:
        default: ASAv Password
      InstanceMetadataServiceVersion:
        default: Instance Metadata Service Version

# Resources section - defines all AWS resources to be created
Resources:
  # Lambda Layer for shared code
  LambdaLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
        - python3.13
      Content:
        S3Bucket: !Ref S3BktName
        S3Key: cluster_layer.zip
      Description: Lambda Layer for Cisco ASAv Cluster Solution
      LayerName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'lambda-layer' ] ]
  # IAM roles and policies for Lambda functions
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'Role' ] ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
  LambdaPolicy:
    DependsOn:
      - LambdaRole
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'Policy' ] ]
      Roles:
        - !Ref LambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - logs:*
              - ec2:*
              - elasticloadbalancing:*
              - autoscaling:*
              - events:*
              - s3:*
              - cloudwatch:*
              - cloudwatch:SetAlarmState
              - cloudwatch:PutMetricData
              - sns:*
              - ssm:*
              - lambda:*
              - kms:Decrypt
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:UpdateItem
            Effect: Allow
            Resource: '*'
  # SNS topic for user notifications
  UserNotifyTopic:
    Condition: UserNotifyEmail
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'UserNotifyTopic']]
  UserNotifyTopicSubscription:
    Condition: UserNotifyEmail
    DependsOn: UserNotifyTopic
    DeletionPolicy: Delete
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !Ref NotifyEmailID
      Protocol: email
      TopicArn: !Ref UserNotifyTopic
  LambdaLockTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'lock'] ]
      AttributeDefinitions:
        - AttributeName: lock_id
          AttributeType: S
      KeySchema:
        - AttributeName: lock_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Name
          Value: LambdaLock
  # Gateway Load Balancer and target groups
  gwlb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'GWLB' ] ]
      Type: gateway
      Subnets: !Ref InsideSubnetIds
      LoadBalancerAttributes: 
        - Key: load_balancing.cross_zone.enabled
          Value: true
  tg:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn:
      - gwlb
    Properties:
      Name: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'GWLB-tg' ] ]
      Port: 6081
      Protocol: GENEVE
      HealthCheckPort: !Ref TgHealthPort
      HealthCheckIntervalSeconds: 5
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      HealthCheckProtocol: TCP
      VpcId: !Ref VpcId
      TargetType: ip
      TargetGroupAttributes:
      - Key: target_failover.on_deregistration
        Value: !Ref TargetFailover
      - Key: target_failover.on_unhealthy
        Value: !Ref TargetFailover
  listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref tg
      LoadBalancerArn: !Ref gwlb

  # VPC Endpoint Service resources
  VpceServiceLambdaExecutionRole:
    Condition: addGWLBE
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              - Effect: Allow
                Action:
                  - ec2:DescribeVpcEndpointServiceConfigurations
                  - ec2:DescribeVpcEndpointServicePermissions
                  - ec2:DescribeVpcEndpointServices
                Resource: "*"

  # Lambda creates CloudWatch Log Group.
  # Since CF stack didn't explicitly create the Log Group, Log Group doesn't get deleted when stack is deleted.
  # Hence creating Log Group though the stack for Lambda specific funciton.
  # Their are few things to consider. For more details refer to: https://github.com/aws/serverless-application-model/issues/1216
  VpceServiceLogGroup:
    Condition: addGWLBE
    Type: AWS::Logs::LogGroup
    Properties:
        LogGroupName: !Sub /aws/lambda/${AWS::StackName}-vpce-service
        RetentionInDays: 1

  VpceServiceName:
    Condition: addGWLBE
    Type: AWS::Lambda::Function
    DependsOn: VpceServiceLogGroup
    Properties:
      FunctionName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'vpce-service'] ]
      Handler: "index.handler"
      Role: !GetAtt VpceServiceLambdaExecutionRole.Arn
      Code:
        ZipFile: |
          import json
          import logging
          import time
          import boto3
          import cfnresponse
          from botocore.exceptions import ClientError
          try:
              ec2 = boto3.client('ec2')
          except ClientError as e:
              logger.error(f"ERROR: failed to connect to EC2 client: {e}")
              sys.exit(1)
          def handler(event, context):
              logger = logging.getLogger()
              logger.setLevel(logging.INFO)
              logger.info('Received event: {}'.format(json.dumps(event)))
              responseData = {}
              responseStatus = cfnresponse.FAILED
              try:
                  serviceid = event["ResourceProperties"]["VpceServiceId"]
              except Exception as e:
                  logger.info('Attribute retrival failure: {}'.format(e))
              try:
                  if event["RequestType"] == "Delete":
                      responseStatus = cfnresponse.SUCCESS
                      cfnresponse.send(event, context, responseStatus, responseData)
              except Exception:
                  logger.exception("Signaling failure to CloudFormation.")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})
              if event["RequestType"] == "Create":
                  logger.info("Retrieving VPC Endpoint Service Name:")
                  try:
                      response = ec2.describe_vpc_endpoint_service_configurations(
                          Filters=[
                              {
                                  'Name': 'service-id',
                                  'Values': [serviceid]
                              }
                          ]
                      )
                  except Exception as e:
                      logger.info('ec2.describe_vpc_endpoint_service_configurations failure: {}'.format(e))
                  service_name = response['ServiceConfigurations'][0]['ServiceName']
                  time.sleep(120)
                  responseData['ServiceName'] = service_name
                  responseStatus = cfnresponse.SUCCESS
                  cfnresponse.send(event, context, responseStatus, responseData)
      Runtime: python3.13
      Timeout: 150

  RetrieveVpceServiceName:
    Condition: addGWLBE
    Type: Custom::RetrieveAttributes
    Properties:
      ServiceToken: !GetAtt VpceServiceName.Arn
      VpceServiceId: !Ref VpcEndpointService

  VpcEndpointService:
    Condition: addGWLBE
    Type: AWS::EC2::VPCEndpointService
    Properties:
      GatewayLoadBalancerArns:
        - !Ref gwlb
      AcceptanceRequired: false

  GwlbEndpoint:
    Condition: addGWLBE
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VpcIdLBE
      ServiceName: !GetAtt RetrieveVpceServiceName.ServiceName
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref GWLBESubnetId

  # Cluster management Lambda function
  ClusterManager:
   Type: AWS::Serverless::Function
   DependsOn:
     - LambdaRole
     - LambdaPolicy
     - CLSmanagerTopic
   DeletionPolicy: Delete
   Properties:
     FunctionName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'manager-lambda'] ]
     Handler: configure_asav_cluster.lambda_handler
     Runtime: python3.13
     ReservedConcurrentExecutions: 16
     CodeUri:
       Bucket: !Ref S3BktName
       Key: configure_asav_cluster.zip
     Description: 'ClusterManager Lambda is responsible to configure cluster on ASAv'
     MemorySize: 128
     Timeout: 900
     VpcConfig:
       SecurityGroupIds: !Ref LambdaSG
       SubnetIds: !Ref LambdaSubnets
     KmsKeyArn: !Ref KmsArn
     Environment:
       Variables:
         DEBUG_LOGS: 'enable'
         KMS_ENC: !If
           - ShouldEncrypt
           - !Ref KmsArn
           - !Ref 'AWS::NoValue'
         ASG_NAME: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber ] ]
         NO_OF_AZs: !Ref NoOfAZs
         AZ_LIST : !If
              - support2zone
              - !Join ['::', [ !Select ['0', !Ref AZ ], !Select ['1', !Ref AZ ] ] ]
              - !If
                - support3zone
                - !Join ['::', [ !Select ['0', !Ref AZ ], !Select ['1', !Ref AZ ], !Select ['2', !Ref AZ ] ] ]
                - !Select ['0', !Ref AZ ]
         ASA_LICENSE_TYPE: !Ref LicenseType
         # ToDo : Pass CCL subnet range
         CCL_SUBNET: !If
              - support2zone
              - !Join ['::', [ !Select ['0', !Ref CCLSubnetIds ], !Select ['1', !Ref CCLSubnetIds ] ] ]
              - !If
                - support3zone
                - !Join ['::', [ !Select ['0', !Ref CCLSubnetIds ], !Select ['1', !Ref CCLSubnetIds ], !Select ['2', !Ref CCLSubnetIds ] ] ]
                - !Select ['0', !Ref CCLSubnetIds ]
         GWLB_ARN: !Ref gwlb
         ASAv_PASSWORD: !Ref asavPassword
         CONFIG_FILE_URL: !If
           - Config_url
           - !Ref ConfigFileURL
           - !Ref 'AWS::NoValue'
         SMART_LIC_TOKEN: !If
           - Lic_token
           - !Ref SmartLicToken
           - !Ref 'AWS::NoValue'
         TG_HEALTH_PORT: !Ref TgHealthPort
         CLS_MANAGER_TOPIC: !Ref CLSmanagerTopic
         USER_NOTIFY_TOPIC_ARN: !If
           - UserNotifyEmail
           - !Ref UserNotifyTopic
           - !Ref 'AWS::NoValue'
     Role: !GetAtt LambdaRole.Arn
     Layers:
       - !Ref LambdaLayer
     Events:
       SNS1:
         Type: SNS
         Properties:
           Topic:
             Ref: CLSmanagerTopic
  ClusterManagerLogGrp:
   DependsOn: ClusterManager
   Type: AWS::Logs::LogGroup
   DeletionPolicy: Delete
   Properties:
     LogGroupName: !Join ['/', ['/aws/lambda', !Ref ClusterManager]]
  InstanceEvent:
   Type: AWS::Events::Rule
   Properties:
     Name: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'notify-instance-event'] ]
     EventPattern:
       source:
         - aws.autoscaling
       detail-type:
         - EC2 Instance Launch Successful
         - EC2 Instance Terminate Successful
       detail:
         AutoScalingGroupName:
           - !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber ] ]
     Targets:
       - Id: CloudWatchEventTarget
         Arn: !GetAtt ClusterManager.Arn
     State: ENABLED
  InstanceEventInvokeLambdaPermission:
   Type: AWS::Lambda::Permission
   DependsOn: InstanceEvent
   Properties:
     FunctionName: !Ref ClusterManager
     Action: 'lambda:InvokeFunction'
     Principal: events.amazonaws.com
     SourceArn: !GetAtt InstanceEvent.Arn
  CLSmanagerTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber , 'cluster-manager-topic'] ]

  # Lifecycle management Lambda function
  LifeCycleLambda:
    Type: AWS::Serverless::Function
    DependsOn:
      - LambdaRole
      - LambdaPolicy
      - CLSmanagerTopic
    DeletionPolicy: Delete
    Properties:
      FunctionName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'lifecycle-lambda'] ]
      Handler: lifecycle_asav_cluster.lambda_handler
      Runtime: python3.13
      CodeUri:
        Bucket: !Ref S3BktName
        Key: lifecycle_asav_cluster.zip
      Description: 'Life Cycle Lambda is responsible to attach interfaces to new ASAv'
      MemorySize: 128
      ReservedConcurrentExecutions: 16
      Timeout: 300
      Role: !GetAtt LambdaRole.Arn
      VpcConfig:
        SecurityGroupIds: !Ref LambdaSG
        SubnetIds: !Ref LambdaSubnets
      Layers:
        - !Ref LambdaLayer
      Environment:
        Variables:
          DEBUG_LOGS: 'enable'
          ASG_NAME: !Join [ '-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber]]
          NO_OF_AZs: !Ref NoOfAZs
          ASA_LICENSE_TYPE: !Ref LicenseType
          PROXY_TYPE: !Ref DeploymentType
          INSIDE_SUBNET: !If
              - support2zone
              - !Join ['::', [ !Select ['0', !Ref InsideSubnetIds ], !Select ['1', !Ref InsideSubnetIds ] ] ]
              - !If
                - support3zone
                - !Join ['::', [ !Select ['0', !Ref InsideSubnetIds ], !Select ['1', !Ref InsideSubnetIds ], !Select ['2', !Ref InsideSubnetIds ] ] ]
                - !Select ['0', !Ref InsideSubnetIds ]
          OUTSIDE_SUBNET: !If
              - dualarm
              - !If
                - dualarmSupport2Zone
                - !Join ['::', [ !Select ['0', !Ref OutsideSubnetIds ], !Select ['1', !Ref OutsideSubnetIds ] ] ]
                - !If
                  - dualarmSupport3Zone
                  - !Join ['::', [ !Select ['0', !Ref OutsideSubnetIds ], !Select ['1', !Ref OutsideSubnetIds ], !Select ['2', !Ref OutsideSubnetIds ] ] ]
                  - !Select ['0', !Ref OutsideSubnetIds ]
              - "NA"
          CCL_SUBNET: !If
              - support2zone
              - !Join ['::', [ !Select ['0', !Ref CCLSubnetIds ], !Select ['1', !Ref CCLSubnetIds ] ] ]
              - !If
                - support3zone
                - !Join ['::', [ !Select ['0', !Ref CCLSubnetIds ], !Select ['1', !Ref CCLSubnetIds ], !Select ['2', !Ref CCLSubnetIds ] ] ]
                - !Select ['0', !Ref CCLSubnetIds ]
          GWLB_ARN: !Ref gwlb
          LB_DEREGISTRATION_DELAY: 180
          SECURITY_GRP_1: !Select ['0', !Ref InsideInterfaceSG ]
          SECURITY_GRP_2: !If [dualarm, !Ref OutsideInterfaceSG, "NA"]
          SECURITY_GRP_3: !Ref CCLInterfaceSG
          CLS_MANAGER_TOPIC: !Ref CLSmanagerTopic
          USER_NOTIFY_TOPIC_ARN: !If
            - UserNotifyEmail
            - !Ref UserNotifyTopic
            - !Ref 'AWS::NoValue'
  LifeCycleLambdaLogGrp:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Join ['/', ['/aws/lambda', !Ref LifeCycleLambda]]
  LifeCycleEvent:
    Type: AWS::Events::Rule
    Properties:
      Name: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'lifecycle-action' ] ]
      EventPattern:
        source:
          - aws.autoscaling
        detail-type:
          - EC2 Instance-launch Lifecycle Action
          - EC2 Instance-terminate Lifecycle Action
        detail:
          AutoScalingGroupName:
            - !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber ] ]
      Targets:
        - Id: CloudWatchEventTarget
          Arn: !GetAtt LifeCycleLambda.Arn
      State: ENABLED
  LifeCycleEventInvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    DependsOn: LifeCycleEvent
    Properties:
      FunctionName: !Ref LifeCycleLambda
      Action: 'lambda:InvokeFunction'
      Principal: events.amazonaws.com
      SourceArn: !GetAtt LifeCycleEvent.Arn

  # Auto Scaling resources
  ScaleOutCPUpolicy:
    DependsOn:
      - ASAvGroup
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref ASAvGroup
      PolicyType: SimpleScaling
      ScalingAdjustment: 1
  ScaleInCPUpolicy:
    DependsOn:
      - ASAvGroup
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref ASAvGroup
      PolicyType: SimpleScaling
      ScalingAdjustment: -1

  # CloudWatch alarms for scaling
  CPUUpperboundAlarm1:
    Condition: DoCpuUpPolcy
    DependsOn:
      - ASAvGroup
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Join ['', [!Ref ClusterGrpNamePrefix, '-',!Ref ClusterNumber, ' CPU-Upper-Threshold-Breach' ] ]
      ActionsEnabled: true
      Namespace: AWS/EC2
      AlarmActions:
        - !Ref ScaleOutCPUpolicy
      AlarmDescription: Alarm when CPU usage hits upper threshold
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 3
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref ASAvGroup
      EvaluationPeriods: 3
      MetricName: CPUUtilization
      Threshold: !Select ['1', !Ref CpuThresholds ]
      Period: 60
      Statistic: Average
      Unit: Percent
  CPULowerboundAlarm1:
    Condition: DoCpuLowPolcy
    DependsOn:
      - ASAvGroup
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Join ['', [!Ref ClusterGrpNamePrefix, '-',!Ref ClusterNumber, ' CPU-Lower-Threshold-Breach' ] ]
      ActionsEnabled: true
      Namespace: AWS/EC2
      AlarmActions:
        - !Ref ScaleInCPUpolicy
      AlarmDescription: Alarm when CPU usage hits lower threshold
      ComparisonOperator: LessThanThreshold
      DatapointsToAlarm: 8
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref ASAvGroup
      EvaluationPeriods: 8
      MetricName: CPUUtilization
      Threshold: !Select ['0', !Ref CpuThresholds ]
      Period: 60
      Statistic: Average
      Unit: Percent

  # Auto Scaling Group and Launch Template
  ASAvGroup:
    DependsOn:
      - LifeCycleEvent
      - InstanceEvent
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber ] ]
      VPCZoneIdentifier: !If
        - support1zone
        - !Split
          - ':'
          - !Select ['0', !Ref MgmtSubnetIds ]
        - !If
          - support2zone
          - !Split
            - ':'
            - !Join [':', [ !Select ['0', !Ref MgmtSubnetIds ], !Select ['1', !Ref MgmtSubnetIds ] ] ]
          - !Split
            - ':'
            - !Join [':', [ !Select ['0', !Ref MgmtSubnetIds ], !Select ['1', !Ref MgmtSubnetIds ], !Select ['2', !Ref MgmtSubnetIds ] ] ]
      LaunchTemplate:
        LaunchTemplateId: !Ref ASAvLaunchTemplate
        Version: 1
      MinSize: 1
      DesiredCapacity: !Ref ClusterSize
      MaxSize: 16
      MetricsCollection:
        - Granularity: 1Minute
          Metrics:
            - GroupDesiredCapacity
            - GroupInServiceInstances
            - GroupTerminatingInstances
            - GroupTotalInstances
            - GroupStandbyInstances
      HealthCheckGracePeriod: 900
      Cooldown: 900
      TerminationPolicies:
        - OldestLaunchConfiguration
        - OldestLaunchTemplate
        - ClosestToNextInstanceHour
      LifecycleHookSpecificationList:
        - DefaultResult: ABANDON
          HeartbeatTimeout: 60
          LifecycleHookName: Launch_LifecycleHook
          LifecycleTransition: 'autoscaling:EC2_INSTANCE_LAUNCHING'
        - DefaultResult: CONTINUE
          HeartbeatTimeout: 400
          LifecycleHookName: Terminate_LifecycleHook
          LifecycleTransition: 'autoscaling:EC2_INSTANCE_TERMINATING'
  ASAvLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Join ['-', [!Ref ClusterGrpNamePrefix, !Ref ClusterNumber, 'ASAv-launch-template' ] ]
      LaunchTemplateData:
        MetadataOptions:
          Fn::If:
            - EnableIMDSv2
            -
              HttpEndpoint: "enabled"  # Use Amazon DNS for metadata service
              HttpProtocolIpv6: "disabled"  # Disable IPv6 for metadata service
              HttpPutResponseHopLimit: 1  # Set hop limit to 1
              HttpTokens: "required"  # Require IMDSv2 for metadata requests
              # InstanceMetadataTags: "enabled"  # Include custom instance metadata tags
            - !Ref "AWS::NoValue"
        EbsOptimized: false
        ImageId: !Ref AmiID
        InstanceType: !Ref InstanceType
        NetworkInterfaces:
          - AssociatePublicIpAddress: !Ref AssignPublicIP
            DeleteOnTermination: true
            DeviceIndex: 0
            Groups: !Ref MgmtInterfaceSG
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              DeleteOnTermination: true
        Monitoring:
          Enabled: true
        UserData:
          Fn::Base64:
            Fn::Join:
              - ""
              - - |
                  ! ASA Version
                  !
                  jumbo-frame reservation
                  !
                  cluster interface-mode individual force
                  !
                  interface Management0/0
                  management-only
                  nameif management
                  security-level 100
                  ip address dhcp setroute
                  !
                - !If
                  - dualarm
                  - |
                      interface TenGigabitEthernet0/0
                      nameif geneve-vtep-ifc
                      security-level 100
                      dhcp client route distance 100
                      ip address dhcp setroute
                      !
                      interface TenGigabitEthernet0/1
                      nameif outside
                      security-level 0
                      ip address dhcp setroute
                      !
                      interface TenGigabitEthernet0/2
                      nve-only cluster
                      nameif ccl_link
                      security-level 0
                      ip address dhcp
                      !
                      interface vni1
                      description Clustering Interface
                      segment-id 1
                      vtep-nve 1
                      !
                      interface vni2
                      proxy dual-arm
                      nameif ge
                      security-level 0
                      vtep-nve 2
                      !
                      nat (ge,outside) source dynamic any interface
                  - |
                      interface TenGigabitEthernet0/0
                      nameif geneve-vtep-ifc
                      security-level 100
                      ip address dhcp setroute
                      !
                      interface TenGigabitEthernet0/1
                      nve-only cluster
                      nameif ccl_link
                      security-level 0
                      ip address dhcp
                      !
                      interface vni1
                      description Clustering Interface
                      segment-id 1
                      vtep-nve 1
                      !
                      interface vni2
                      proxy single-arm
                      nameif ge
                      security-level 0
                      vtep-nve 2
                      !
                - !If
                  - support3zone
                  - !Sub
                    - |
                      object network ccl_link1
                      range ${CCLSubnet0}
                      object network ccl_link2
                      range ${CCLSubnet1}
                      object network ccl_link3
                      range ${CCLSubnet2}
                      object-group network cluster_group
                      network-object object ccl_link1
                      network-object object ccl_link2
                      network-object object ccl_link3
                    - CCLSubnet0: !Select ['0', !Ref CCLSubnetRanges ]
                      CCLSubnet1: !Select ['1', !Ref CCLSubnetRanges ]
                      CCLSubnet2: !Select ['2', !Ref CCLSubnetRanges ]
                  - !If
                    - support2zone
                    - !Sub
                      - |
                        object network ccl_link1
                        range ${CCLSubnet0}
                        object network ccl_link2
                        range ${CCLSubnet1}
                        object-group network cluster_group
                        network-object object ccl_link1
                        network-object object ccl_link2
                      - CCLSubnet0: !Select ['0', !Ref CCLSubnetRanges ]
                        CCLSubnet1: !Select ['1', !Ref CCLSubnetRanges ]
                    - !Sub 
                      - |
                        object network ccl_link
                        range ${CCLSubnet0}
                        object-group network cluster_group
                        network-object object ccl_link
                      - CCLSubnet0: !Select ['0', !Ref CCLSubnetRanges ]
                - |
                    nve 2
                    encapsulation geneve
                    source-interface geneve-vtep-ifc
                    nve 1
                    encapsulation vxlan
                    source-interface ccl_link
                    peer-group cluster_group
                    !
                    same-security-traffic permit inter-interface
                    same-security-traffic permit intra-interface
                    !
                    mtu geneve-vtep-ifc 1826
                    mtu ccl_link 1980
                - !Sub
                  - |
                    aaa authentication listener http geneve-vtep-ifc port ${TgHealthPort}
                    !
                    crypto key generate rsa modulus 2048
                    username asavuser password AsAv_ClU3TeR44 privilege 15
                    ssh 0 0 management
                    aaa authentication ssh console LOCAL
                    ssh version 2
                    ssh timeout 60
                    !
                    enable password AsAv_ClU3TeR44 level 15
                    !
                    dns domain-lookup management
                    DNS server-group DefaultDNS
                        name-server 8.8.8.8 management
                    ! Comment following license configuration if you are using PAYG licensing
                    ! License configuration
                    call-home
                    profile License
                    destination transport-method http
                    destination address http https://tools.cisco.com/its/service/oddce/services/DDCEService
                    license smart
                    feature tier standard
                    throughput level 1G
                    wr mem
                    ! license smart register idtoken <TOKEN>
                  - TgHealthPort1: !Ref TgHealthPort
